<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brand Shield v2.0</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
        }
        a { color: #38bdf8; text-decoration: none; }
        a:hover { text-decoration: underline; }

        /* âââ Top Nav âââ */
        .topnav {
            background: rgba(15,23,42,0.95);
            border-bottom: 1px solid rgba(255,255,255,0.08);
            padding: 0 32px;
            display: flex;
            align-items: center;
            height: 60px;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(12px);
        }
        .topnav .logo {
            font-weight: 800;
            font-size: 18px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .topnav .logo span { color: #38bdf8; }
        .topnav .brand-toggle {
            margin-left: 32px;
            display: flex;
            gap: 6px;
        }
        .brand-toggle button {
            padding: 6px 14px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.15);
            background: transparent;
            color: #94a3b8;
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .brand-toggle button.active {
            background: #0ea5e9;
            color: #fff;
            border-color: #0ea5e9;
        }
        .brand-toggle button:hover:not(.active) {
            border-color: #38bdf8;
            color: #e2e8f0;
        }
        .topnav .right {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .topnav .user {
            color: #94a3b8;
            font-size: 13px;
        }
        .topnav .user b { color: #e2e8f0; }
        .btn-sm {
            padding: 6px 14px;
            border-radius: 6px;
            border: none;
            font-family: inherit;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }
        .btn-primary { background: #0ea5e9; color: #fff; }
        .btn-primary:hover { background: #0284c7; }
        .btn-danger { background: #ef4444; color: #fff; }
        .btn-danger:hover { background: #dc2626; }
        .btn-outline {
            background: transparent;
            color: #94a3b8;
            border: 1px solid rgba(255,255,255,0.15);
        }
        .btn-outline:hover { border-color: #38bdf8; color: #e2e8f0; }

        /* âââ Layout âââ */
        .main { padding: 24px 32px; max-width: 1400px; margin: 0 auto; }

        /* âââ Tabs âââ */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            padding-bottom: 0;
        }
        .tab {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: #64748b;
            font-family: inherit;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            margin-bottom: -1px;
        }
        .tab:hover { color: #e2e8f0; }
        .tab.active {
            color: #38bdf8;
            border-bottom-color: #38bdf8;
        }
        .tab .count {
            background: rgba(14,165,233,0.15);
            color: #38bdf8;
            padding: 1px 7px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 6px;
        }
        .tab.active .count {
            background: rgba(14,165,233,0.3);
        }

        /* âââ Stats Grid âââ */
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: linear-gradient(135deg, rgba(14,165,233,0.12) 0%, rgba(168,85,247,0.12) 100%);
            border: 1px solid rgba(255,255,255,0.08);
            padding: 20px 24px;
            border-radius: 12px;
        }
        .stat-card .label {
            font-size: 11px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .stat-card .value {
            font-size: 32px;
            font-weight: 800;
            color: #fff;
            line-height: 1;
        }
        .stat-card .detail {
            font-size: 12px;
            color: #64748b;
            margin-top: 6px;
        }
        .stat-card .detail .up { color: #22c55e; }
        .stat-card .detail .down { color: #ef4444; }

        /* âââ Panel âââ */
        .panel {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .panel-header h3 {
            font-size: 14px;
            font-weight: 700;
            color: #f1f5f9;
        }
        .panel-body { padding: 0; }

        /* âââ Threat List âââ */
        .threat-row {
            display: grid;
            grid-template-columns: 36px 1fr 100px 90px 80px 100px;
            align-items: center;
            padding: 14px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            transition: background 0.15s;
            gap: 12px;
        }
        .threat-row:hover { background: rgba(255,255,255,0.03); }
        .threat-row:last-child { border-bottom: none; }
        .threat-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        .threat-icon.impersonation { background: rgba(239,68,68,0.15); }
        .threat-icon.content_theft { background: rgba(245,158,11,0.15); }
        .threat-icon.counterfeit { background: rgba(168,85,247,0.15); }
        .threat-icon.text_theft { background: rgba(14,165,233,0.15); }
        .threat-info .title {
            font-size: 13px;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 3px;
        }
        .threat-info .url {
            font-size: 11px;
            color: #64748b;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: capitalize;
        }
        .badge-critical { background: rgba(239,68,68,0.2); color: #f87171; }
        .badge-high { background: rgba(245,158,11,0.2); color: #fbbf24; }
        .badge-medium { background: rgba(14,165,233,0.2); color: #38bdf8; }
        .badge-low { background: rgba(34,197,94,0.2); color: #4ade80; }
        .badge-new { background: rgba(14,165,233,0.2); color: #38bdf8; }
        .badge-reported { background: rgba(245,158,11,0.2); color: #fbbf24; }
        .badge-resolved { background: rgba(34,197,94,0.2); color: #4ade80; }
        .badge-sent { background: rgba(168,85,247,0.2); color: #c084fc; }
        .badge-draft { background: rgba(100,116,139,0.2); color: #94a3b8; }
        .confidence {
            font-size: 13px;
            font-weight: 700;
            color: #fff;
        }
        .platform-tag {
            font-size: 11px;
            color: #94a3b8;
            text-transform: capitalize;
        }
        .actions-cell {
            display: flex;
            gap: 6px;
        }
        .act-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.1);
            background: transparent;
            color: #94a3b8;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            transition: all 0.15s;
        }
        .act-btn:hover { border-color: #38bdf8; color: #38bdf8; background: rgba(56,189,248,0.1); }
        .act-btn.dmca:hover { border-color: #a855f7; color: #a855f7; background: rgba(168,85,247,0.1); }
        .act-btn.resolve:hover { border-color: #22c55e; color: #22c55e; background: rgba(34,197,94,0.1); }

        /* âââ DMCA Table âââ */
        .dmca-row {
            display: grid;
            grid-template-columns: 1fr 100px 100px 90px 120px;
            align-items: center;
            padding: 14px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            gap: 12px;
        }
        .dmca-row:hover { background: rgba(255,255,255,0.03); }

        /* âââ Suspects âââ */
        .suspect-row {
            display: grid;
            grid-template-columns: 1fr 100px 80px 100px;
            align-items: center;
            padding: 14px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            gap: 12px;
        }
        .suspect-row:hover { background: rgba(255,255,255,0.03); }
        .risk-bar {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.08);
            border-radius: 3px;
            overflow: hidden;
        }
        .risk-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
        }

        /* âââ Modal âââ */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal {
            background: #1e293b;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 24px;
        }
        .modal h2 {
            font-size: 18px;
            margin-bottom: 16px;
            color: #fff;
        }
        .modal pre {
            background: #0f172a;
            padding: 16px;
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.6;
            color: #94a3b8;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 400px;
            overflow-y: auto;
        }
        .modal .modal-actions {
            margin-top: 16px;
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        /* âââ Tab Content âââ */
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* âââ Empty State âââ */
        .empty {
            text-align: center;
            padding: 40px;
            color: #475569;
        }

        /* âââ Loading âââ */
        .loading-bar {
            height: 3px;
            background: linear-gradient(90deg, #0ea5e9, #a855f7, #0ea5e9);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            z-index: 101;
            display: none;
        }
        .loading-bar.active { display: block; }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* âââ Breakdowns âââ */
        .breakdown-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }
        .breakdown-card {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 20px;
        }
        .breakdown-card h4 {
            font-size: 12px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 14px;
        }
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
        }
        .breakdown-item .name {
            font-size: 13px;
            color: #94a3b8;
            text-transform: capitalize;
        }
        .breakdown-item .val {
            font-size: 14px;
            font-weight: 700;
            color: #f1f5f9;
        }
        .bar-track {
            flex: 1;
            height: 4px;
            background: rgba(255,255,255,0.06);
            border-radius: 2px;
            margin: 0 12px;
            overflow: hidden;
        }
        .bar-fill {
            height: 100%;
            border-radius: 2px;
            background: #0ea5e9;
        }

        @media (max-width: 768px) {
            .stats { grid-template-columns: repeat(2, 1fr); }
            .breakdown-grid { grid-template-columns: 1fr; }
            .threat-row { grid-template-columns: 1fr; gap: 6px; }
            .topnav { padding: 0 16px; }
            .main { padding: 16px; }
        }
    </style>
</head>
<body>
    <div class="topnav">
        <div class="logo">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#38bdf8" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
            </svg>
            Brand <span>Shield</span>
        </div>
        <div class="brand-toggle">
            <button class="active" onclick="setBrand('all')">All Brands</button>
            <button onclick="setBrand('@erim')">@erim</button>
            <button onclick="setBrand('@byerim')">@byerim</button>
        </div>
        <div class="right">
            <span class="user">Logged in as <b id="username">â</b></span>
            <button class="btn-sm btn-primary" onclick="refreshAll()">Refresh</button>
            <button class="btn-sm btn-danger" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="loading-bar" id="loadingBar"></div>

    <div class="main">
        <!-- Stats -->
        <div class="stats" id="statsGrid"></div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('threats')">
                Threats <span class="count" id="threatCount">0</span>
            </button>
            <button class="tab" onclick="switchTab('dmca')">
                DMCA Notices <span class="count" id="dmcaCount">0</span>
            </button>
            <button class="tab" onclick="switchTab('suspects')">
                Suspicious Accounts <span class="count" id="suspectCount">0</span>
            </button>
            <button class="tab" onclick="switchTab('overview')">
                Overview
            </button>
        </div>

        <!-- Tab: Threats -->
        <div class="tab-content active" id="tab-threats">
            <div class="panel">
                <div class="panel-header">
                    <h3>Detected Threats</h3>
                    <div style="display:flex;gap:6px;">
                        <select id="threatFilter" onchange="loadThreats()" style="background:#0f172a;color:#94a3b8;border:1px solid rgba(255,255,255,0.15);padding:5px 10px;border-radius:6px;font-family:inherit;font-size:12px;">
                            <option value="">All Types</option>
                            <option value="impersonation">Impersonation</option>
                            <option value="content_theft">Content Theft</option>
                            <option value="counterfeit">Counterfeit</option>
                            <option value="text_theft">Text Theft</option>
                        </select>
                        <select id="statusFilter" onchange="loadThreats()" style="background:#0f172a;color:#94a3b8;border:1px solid rgba(255,255,255,0.15);padding:5px 10px;border-radius:6px;font-family:inherit;font-size:12px;">
                            <option value="">All Status</option>
                            <option value="new">New</option>
                            <option value="reported">Reported</option>
                            <option value="resolved">Resolved</option>
                        </select>
                    </div>
                </div>
                <div class="panel-body" id="threatsList"></div>
            </div>
        </div>

        <!-- Tab: DMCA -->
        <div class="tab-content" id="tab-dmca">
            <div class="panel">
                <div class="panel-header">
                    <h3>DMCA Takedown Notices</h3>
                </div>
                <div class="panel-body" id="dmcaList"></div>
            </div>
        </div>

        <!-- Tab: Suspects -->
        <div class="tab-content" id="tab-suspects">
            <div class="panel">
                <div class="panel-header">
                    <h3>Suspicious Accounts</h3>
                </div>
                <div class="panel-body" id="suspectsList"></div>
            </div>
        </div>

        <!-- Tab: Overview -->
        <div class="tab-content" id="tab-overview">
            <div class="breakdown-grid" id="breakdownGrid"></div>
            <div class="panel">
                <div class="panel-header"><h3>Recent Scan History</h3></div>
                <div class="panel-body" id="scanHistory"></div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay" style="display:none;" onclick="closeModal(event)">
        <div class="modal" id="modalContent"></div>
    </div>

    <script>
        let currentBrand = '';
        let statsData = null;

        // âââ Init âââ
        async function init() {
            const me = await api('/api/auth/me');
            if (me.username) document.getElementById('username').textContent = me.username;
            await refreshAll();
        }

        async function refreshAll() {
            showLoading(true);
            await Promise.all([loadStats(), loadThreats(), loadDMCA(), loadSuspects(), loadScans()]);
            showLoading(false);
        }

        function showLoading(v) {
            document.getElementById('loadingBar').classList.toggle('active', v);
        }

        // âââ API âââ
        async function api(url, opts) {
            try {
                const r = await fetch(url, opts);
                if (r.status === 401) { window.location.href = '/login'; return {}; }
                return await r.json();
            } catch(e) {
                console.error('API error:', url, e);
                return {};
            }
        }

        // âââ Brand Filter âââ
        function setBrand(brand) {
            currentBrand = brand === 'all' ? '' : brand;
            document.querySelectorAll('.brand-toggle button').forEach(b => {
                b.classList.toggle('active',
                    (brand === 'all' && !b.textContent.includes('@')) ||
                    b.textContent.trim() === brand
                );
            });
            refreshAll();
        }

        // âââ Tabs âââ
        function switchTab(name) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.closest('.tab').classList.add('active');
            document.getElementById('tab-' + name).classList.add('active');
        }

        // âââ Stats âââ
        async function loadStats() {
            const data = await api('/api/dashboard/stats');
            statsData = data;
            const t = data.threats || {};
            const d = data.dmca || {};
            const s = data.suspects || {};

            document.getElementById('threatCount').textContent = t.total || 0;
            document.getElementById('dmcaCount').textContent = d.total || 0;
            document.getElementById('suspectCount').textContent = s.total || 0;

            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card">
                    <div class="label">Active Threats</div>
                    <div class="value">${t.new || 0}</div>
                    <div class="detail">${t.total || 0} total detected</div>
                </div>
                <div class="stat-card">
                    <div class="label">Critical / High</div>
                    <div class="value" style="color:#f87171">${(t.by_severity?.critical || 0) + (t.by_severity?.high || 0)}</div>
                    <div class="detail">${t.by_severity?.critical || 0} critical, ${t.by_severity?.high || 0} high</div>
                </div>
                <div class="stat-card">
                    <div class="label">DMCA Notices</div>
                    <div class="value">${d.total || 0}</div>
                    <div class="detail">${d.success_rate || 0}% success rate</div>
                </div>
                <div class="stat-card">
                    <div class="label">Suspicious Accounts</div>
                    <div class="value">${s.total || 0}</div>
                    <div class="detail">${t.resolved || 0} threats resolved</div>
                </div>
            `;
        }

        // âââ Threats âââ
        async function loadThreats() {
            let url = '/api/threats?';
            if (currentBrand) url += `brand=${encodeURIComponent(currentBrand)}&`;
            const typeF = document.getElementById('threatFilter')?.value;
            if (typeF) url += `type=${typeF}&`;
            const statusF = document.getElementById('statusFilter')?.value;
            if (statusF) url += `status=${statusF}&`;

            const data = await api(url);
            const list = data.threats || [];

            if (!list.length) {
                document.getElementById('threatsList').innerHTML = '<div class="empty">No threats found</div>';
                return;
            }

            const icons = { impersonation: 'ð¤', content_theft: 'ð¸', counterfeit: 'ðï¸', text_theft: 'ð' };

            document.getElementById('threatsList').innerHTML = list.map(t => `
                <div class="threat-row">
                    <div class="threat-icon ${t.threat_type}">${icons[t.threat_type] || 'â ï¸'}</div>
                    <div class="threat-info">
                        <div class="title">${esc(t.infringer_username || 'Unknown')} <span style="color:#64748b;font-weight:400;">â ${esc(t.threat_type.replace('_',' '))}</span></div>
                        <div class="url">${esc(t.detected_url || '')}</div>
                    </div>
                    <div class="platform-tag">${esc(t.platform || '')}</div>
                    <div><span class="badge badge-${t.severity}">${t.severity}</span></div>
                    <div class="confidence">${Math.round((t.confidence || 0) * 100)}%</div>
                    <div class="actions-cell">
                        <button class="act-btn dmca" title="Generate DMCA" onclick="generateDMCA(${t.id})">ð</button>
                        ${t.status !== 'resolved' ? `<button class="act-btn resolve" title="Mark Resolved" onclick="resolveThreat(${t.id})">â</button>` : ''}
                        <button class="act-btn" title="View Details" onclick="viewThreat(${t.id})">ð</button>
                    </div>
                </div>
            `).join('');
        }

        // âââ DMCA âââ
        async function loadDMCA() {
            const data = await api('/api/dmca');
            const list = data.notices || [];

            if (!list.length) {
                document.getElementById('dmcaList').innerHTML = '<div class="empty">No DMCA notices yet. Click the ð icon on a threat to generate one.</div>';
                return;
            }

            document.getElementById('dmcaList').innerHTML = list.map(n => `
                <div class="dmca-row">
                    <div>
                        <div style="font-size:13px;font-weight:600;color:#f1f5f9;">${esc(n.subject_line || n.notice_type)}</div>
                        <div style="font-size:11px;color:#64748b;">${esc(n.recipient_platform || '')} â ${esc(n.infringer_username || '')}</div>
                    </div>
                    <div><span class="badge badge-${n.status}">${n.status}</span></div>
                    <div class="platform-tag">${esc(n.notice_type || '')}</div>
                    <div style="font-size:12px;color:#64748b;">${formatDate(n.created_at)}</div>
                    <div>
                        <button class="btn-sm btn-outline" onclick="viewDMCA(${n.id})">View Notice</button>
                    </div>
                </div>
            `).join('');
        }

        // âââ Suspects âââ
        async function loadSuspects() {
            let url = '/api/suspects?';
            if (currentBrand) url += `brand=${encodeURIComponent(currentBrand)}`;
            const data = await api(url);
            const list = data.suspects || [];

            if (!list.length) {
                document.getElementById('suspectsList').innerHTML = '<div class="empty">No suspicious accounts detected</div>';
                return;
            }

            document.getElementById('suspectsList').innerHTML = list.map(s => {
                const score = Math.round((s.risk_score || 0) * 100);
                const color = score >= 80 ? '#ef4444' : score >= 60 ? '#f59e0b' : '#22c55e';
                const reasons = s.detection_reasons || [];
                return `
                <div class="suspect-row">
                    <div>
                        <div style="font-size:13px;font-weight:600;color:#f1f5f9;">
                            ${esc(s.username)} <span style="color:#64748b;font-weight:400;">on ${esc(s.platform)}</span>
                        </div>
                        <div style="font-size:11px;color:#64748b;margin-top:3px;">${esc(s.display_name || '')} â ${esc(s.bio_text || '').substring(0, 60)}...</div>
                        <div style="font-size:11px;color:#475569;margin-top:4px;">${reasons.map(r => 'â¢ ' + esc(r)).join(' ')}</div>
                    </div>
                    <div style="font-size:12px;color:#94a3b8;">${(s.follower_count || 0).toLocaleString()} followers</div>
                    <div>
                        <div style="font-size:14px;font-weight:700;color:${color};">${score}%</div>
                        <div class="risk-bar"><div class="risk-bar-fill" style="width:${score}%;background:${color};"></div></div>
                    </div>
                    <div>
                        <a href="${esc(s.profile_url || '#')}" target="_blank" class="btn-sm btn-outline">View Profile</a>
                    </div>
                </div>
            `}).join('');
        }

        // âââ Scan History âââ
        async function loadScans() {
            const data = await api('/api/scan/history');
            const scans = data.scans || [];

            // Breakdown
            if (statsData) {
                const t = statsData.threats || {};
                document.getElementById('breakdownGrid').innerHTML = `
                    <div class="breakdown-card">
                        <h4>By Threat Type</h4>
                        ${Object.entries(t.by_type || {}).map(([k,v]) => breakdownItem(k.replace('_',' '), v, t.total)).join('')}
                    </div>
                    <div class="breakdown-card">
                        <h4>By Platform</h4>
                        ${Object.entries(t.by_platform || {}).map(([k,v]) => breakdownItem(k, v, t.total)).join('')}
                    </div>
                    <div class="breakdown-card">
                        <h4>By Severity</h4>
                        ${Object.entries(t.by_severity || {}).map(([k,v]) => breakdownItem(k, v, t.total)).join('')}
                    </div>
                    <div class="breakdown-card">
                        <h4>By Brand</h4>
                        ${Object.entries(t.by_brand || {}).map(([k,v]) => breakdownItem(k, v, t.total)).join('')}
                    </div>
                `;
            }

            if (!scans.length) {
                document.getElementById('scanHistory').innerHTML = '<div class="empty">No scans yet</div>';
                return;
            }
            document.getElementById('scanHistory').innerHTML = scans.map(s => `
                <div style="padding:12px 20px;border-bottom:1px solid rgba(255,255,255,0.04);display:flex;justify-content:space-between;align-items:center;">
                    <div>
                        <span style="font-size:13px;font-weight:600;color:#f1f5f9;">${esc(s.scan_type)}</span>
                        <span style="color:#64748b;font-size:12px;margin-left:8px;">${esc(s.brand || 'all')} / ${esc(s.platform || 'all')}</span>
                    </div>
                    <div style="display:flex;gap:16px;align-items:center;">
                        <span style="font-size:12px;color:#94a3b8;">${s.items_scanned} scanned</span>
                        <span style="font-size:12px;color:#f87171;font-weight:600;">${s.threats_found} found</span>
                        <span style="font-size:12px;color:#64748b;">${(s.execution_time_seconds || 0).toFixed(1)}s</span>
                        <span class="badge badge-${s.status === 'completed' ? 'resolved' : 'new'}">${s.status}</span>
                    </div>
                </div>
            `).join('');
        }

        function breakdownItem(name, val, total) {
            const pct = total > 0 ? Math.round(val / total * 100) : 0;
            return `<div class="breakdown-item">
                <span class="name">${esc(name)}</span>
                <div class="bar-track"><div class="bar-fill" style="width:${pct}%"></div></div>
                <span class="val">${val}</span>
            </div>`;
        }

        // âââ Actions âââ
        async function generateDMCA(threatId) {
            showLoading(true);
            const data = await api('/api/dmca/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ threat_id: threatId, notice_type: 'general' })
            });
            showLoading(false);

            if (data.body_preview) {
                showModal(`
                    <h2>DMCA Notice Generated</h2>
                    <pre>${esc(data.body_preview)}</pre>
                    <div class="modal-actions">
                        <button class="btn-sm btn-outline" onclick="closeModal()">Close</button>
                    </div>
                `);
                await refreshAll();
            } else {
                alert('Error generating DMCA: ' + (data.error || 'Unknown error'));
            }
        }

        async function resolveThreat(tid) {
            await api(`/api/threats/${tid}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: 'resolved' })
            });
            await refreshAll();
        }

        async function viewThreat(tid) {
            const t = await api(`/api/threats/${tid}`);
            if (!t.id) return;
            let evidence = '';
            try {
                const ev = typeof t.evidence === 'string' ? JSON.parse(t.evidence) : (t.evidence || {});
                evidence = Object.entries(ev).map(([k,v]) => `${k}: ${v}`).join('\n');
            } catch(e) {}

            showModal(`
                <h2>Threat #${t.id}: ${esc(t.threat_type)}</h2>
                <div style="margin-bottom:16px;">
                    <p><strong>Brand:</strong> ${esc(t.brand)}</p>
                    <p><strong>Platform:</strong> ${esc(t.platform)}</p>
                    <p><strong>Infringer:</strong> ${esc(t.infringer_username)}</p>
                    <p><strong>URL:</strong> <a href="${esc(t.detected_url)}" target="_blank">${esc(t.detected_url)}</a></p>
                    <p><strong>Confidence:</strong> ${Math.round((t.confidence || 0) * 100)}%</p>
                    <p><strong>Severity:</strong> <span class="badge badge-${t.severity}">${t.severity}</span></p>
                    <p><strong>Status:</strong> <span class="badge badge-${t.status}">${t.status}</span></p>
                    <p><strong>Detected:</strong> ${formatDate(t.detected_at)}</p>
                </div>
                ${evidence ? `<h3 style="font-size:14px;margin-bottom:8px;">Evidence</h3><pre>${esc(evidence)}</pre>` : ''}
                ${t.dmca_notices?.length ? `<h3 style="font-size:14px;margin:16px 0 8px;">DMCA Notices (${t.dmca_notices.length})</h3>` : ''}
                <div class="modal-actions">
                    ${t.status !== 'resolved' ? `<button class="btn-sm btn-primary" onclick="resolveThreat(${t.id});closeModal();">Mark Resolved</button>` : ''}
                    <button class="btn-sm btn-outline" onclick="closeModal()">Close</button>
                </div>
            `);
        }

        async function viewDMCA(nid) {
            const n = await api(`/api/dmca/${nid}`);
            if (!n.id) return;
            showModal(`
                <h2>${esc(n.subject_line || 'DMCA Notice')}</h2>
                <pre>${esc(n.body || '')}</pre>
                <div class="modal-actions">
                    <button class="btn-sm btn-primary" onclick="copyDMCA(this)" data-body="${btoa(n.body || '')}">Copy to Clipboard</button>
                    <button class="btn-sm btn-outline" onclick="closeModal()">Close</button>
                </div>
            `);
        }

        function copyDMCA(btn) {
            const text = atob(btn.dataset.body);
            navigator.clipboard.writeText(text).then(() => {
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = 'Copy to Clipboard', 2000);
            });
        }

        // âââ Modal âââ
        function showModal(html) {
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('modalOverlay').style.display = 'flex';
        }
        function closeModal(e) {
            if (!e || e.target === document.getElementById('modalOverlay')) {
                document.getElementById('modalOverlay').style.display = 'none';
            }
        }

        // âââ Helpers âââ
        function esc(str) {
            const d = document.createElement('div');
            d.textContent = str || '';
            return d.innerHTML;
        }
        function formatDate(d) {
            if (!d) return 'â';
            return new Date(d).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        }
        function logout() {
            fetch('/api/auth/logout', { method: 'POST' }).then(() => window.location.href = '/login');
        }

        // Go
        init();
    </script>
</body>
</html>
